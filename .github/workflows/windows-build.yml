name: Windows Build and Release

on:
  push:
    tags:
      - 'v*' # Trigger on version tags like v1.0.1
  workflow_dispatch: # Allow manual triggering

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Cache Build Folder
      uses: actions/cache@v4
      with:
        path: build
        key: ${{ runner.os }}-msvc-build-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-msvc-build-

    - name: Run Build Script
      # Call your batch script. Ensure it handles cmake configure, build, and install.
      shell: cmd
      run: |
        call build.bat

    - name: Prepare Artifacts for Release
      # Using PowerShell to create a ZIP of the install directory
      # Assuming build.bat installs files to 'build/install'
      shell: pwsh
      run: |
        Compress-Archive -Path build/install/* -DestinationPath libstack-windows-x64.zip

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: libstack-windows-x64.zip
        name: Windows Release ${{ github.ref_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}